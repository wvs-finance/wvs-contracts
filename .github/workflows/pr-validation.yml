name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR is linked to an issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const prBody = pr.body || '';
            const prTitle = pr.title || '';
            
            // Check if PR description or title references an issue
            const issuePattern = /(?:closes?|fixes?|resolves?|relates? to)\s+#\d+/i;
            const hasIssueReference = issuePattern.test(prBody) || issuePattern.test(prTitle);
            
            if (!hasIssueReference) {
              core.warning('⚠️ This PR does not appear to be linked to an issue.');
              core.warning('Please link your PR to an issue using keywords like "closes #123" or "fixes #456" in the PR description.');
              core.warning('This is a warning, not a blocker, but linking to issues helps track work.');
            } else {
              const matches = prBody.match(issuePattern) || prTitle.match(issuePattern) || [];
              core.info(`✅ PR is linked to issue(s): ${matches.join(', ')}`);
            }

      - name: Check for direct commits to main
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            if (pr.base.ref === 'main' && pr.head.ref === 'main') {
              core.setFailed('❌ Direct commits to main branch are not allowed. Please create a feature branch.');
            } else {
              core.info(`✅ PR is from ${pr.head.ref} to ${pr.base.ref}`);
            }

